name: CD-Deploy

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

env:
  SERVER_IP: 5.129.250.92
  DEPLOY_USER: root
  key: ${{ secrets.SSH_PRIVATE_KEY }}


jobs:
  
  deploy:
    name: Deploy to Server
    runs-on: self-hosted
    steps:
      - name: Deploy with docker-compose
        run: |
          cd /opt
          if [ -d "django-DefectDojo" ]; then
            rm -rf django-DefectDojo
            echo "Existing project directory removed"
          fi
          sleep 300
          mkdir django-DefectDojo
          echo "New project directory created"
          git clone https://github.com/DefectDojo/django-DefectDojo
          cd django-DefectDojo
          sleep 1000
          ./docker/docker-compose-check.sh
          sleep 100
          docker compose build
          sleep 1500
          docker-compose up -d
          sleep 1500
          docker compose logs initializer | grep "Admin password:"
          sleep 1500
